const router = require("express").Router();

const passport = require("passport");
const db = require("../../../db/db.js");
const otp = require("otplib");

router.post(
  "/user/activate_2FA",
  passport.authenticate("jwt", { failWithError: true, session: false }),
  async (req, res, next) => {
    // Get user
    try {
      user = await db.user.findOne({ where: { userid: req.user._id } });
    } catch (error) {
      return res.status(500).json({
        error: true,
        message: "Failed to get user.",
      });
    }
    if (!user.MFA_secret) {
      return res.status(403).json({
        error: true,
        message: "2FA secret not requested.",
      });
    }
    if (user.MFA_active) {
      return res.status(403).json({
        error: true,
        message: "2FA is already enabled.",
      });
    }
    if (otp.authenticator.check(req.body.totp_code, user.MFA_secret)) {
      // If the totp code provided by the user matches the one generated by the secret in the db, set 2FA as active
      try {
        await db.user.update(
          { MFA_active: true },
          { where: { userid: req.user._id } }
        );
      } catch (error) {
        return res
          .status(500)
          .json({ error: true, message: "Failed to activate 2FA." });
      }
      return res.status(200).json({
        error: false,
        message: "2FA activated successfully.",
      });
    }
    return res.status(403).json({
      error: true,
      message: "Incorrect TOTP code.",
    });
  }
);

module.exports = router;
